###############
一、更新数据库
###############
------------------- zyg -----------------------------------------------------------
1、增加表
use mlw_bkstage;
CREATE TABLE `bks_market_mail` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `mail` varchar(64) NOT NULL DEFAULT '' COMMENT '邮箱名',
  `send_times` int(11) NOT NULL DEFAULT '0' COMMENT '发送次数',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `mail` (`mail`) USING BTREE
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

use mlw_order;
create index ord_transport_IDX on oms_ord_transport(order_id ,logistics_number);

2、数据库相关：pms模块的数据库全部更换整个数据库，由原来的mlw_prod改为mlw_product
线上的mlw_prod先备份，141 3307 mlw_product 直接迁移到线上,然后做一品多规数据迁移；

3.日志相关
use mlw_monitor;
alter table mlw_log add column error_uuid varchar(50);
alter table monitor_log add column error_uuid varchar(50);


------------------- wzx -----------------------------------------------------------
 一品多规的业务数据迁移部分sql 
--第一部分：
insert into mlw_product.card select * from mlw_prod.card; 
insert into mlw_product.card_batch select * from mlw_prod.card_batch; 
insert into mlw_product.card_import_log select * from mlw_prod.card_import_log; 
insert into mlw_product.card_import_result select * from mlw_prod.card_import_result; 
insert into mlw_product.card_opt_log select * from mlw_prod.card_opt_log; 
insert into mlw_product.pro_brand select * from mlw_prod.pro_brand; 
insert into mlw_product.pro_brand_category select * from mlw_prod.pro_brand_category; 
insert into mlw_product.pro_category select * from mlw_prod.pro_category; 
insert into mlw_product.pro_comment select * from mlw_prod.pro_comment; 
insert into mlw_product.pro_comment_click select * from mlw_prod.pro_comment_click; 
insert into mlw_product.pro_comment_dv select * from mlw_prod.pro_comment_dv; 
insert into mlw_product.pro_consult select * from mlw_prod.pro_consult; 
insert into mlw_product.pro_enterprise_purchase select * from mlw_prod.pro_enterprise_purchase; 
insert into mlw_product.pro_place select * from mlw_prod.pro_place; 
insert into mlw_product.pro_store select * from mlw_prod.pro_store; 
insert into mlw_product.pro_store_category select * from mlw_prod.pro_store_category; 
insert into mlw_product.pro_supplier select * from mlw_prod.pro_supplier; 
insert into mlw_product.pro_stock select * from mlw_prod.pro_stock; 
insert into mlw_product.pro_stock_log select * from mlw_prod.pro_stock_log; 
insert into mlw_product.stock_import_log select * from mlw_prod.stock_import_log; 
insert into mlw_product.stock_import_result select * from mlw_prod.stock_import_result; 
insert into mlw_product.wish_card select * from mlw_prod.wish_card;
INSERT INTO mlw_product.pro_location SELECT * FROM mlw_prod.pro_location;


--第二部分：
insert into mlw_product.pro_spu select pro_id,pro_name,short_name,adv_name,0,first_category_id,second_category_id,third_category_id,brand_id,supplier_id,place_id,admin_id,property_string,is_cod,1,0,'','',1,create_time,delete_time,update_time from mlw_prod.pro_product;
INSERT INTO mlw_product.pro_detail SELECT pro_id,summary,descp_menu,descp,sale_tag,search_keyword,seo_title,seo_keyword,seo_descp,factory,editor_rec from mlw_prod.pro_detail;
INSERT INTO mlw_product.pro_images SELECT p.pro_id,0,0,default_image_uri,image_uris,create_time,update_time FROM mlw_prod.pro_product p,mlw_prod.pro_detail d WHERE p.pro_id = d.pro_id;
INSERT INTO mlw_product.pro_property SELECT pro_prop_id,parent_id,name,descp,category_id,state,admin_id,sequence,0,property_type,is_required,is_filter,create_time,update_time from mlw_prod.pro_property; 
INSERT INTO mlw_product.pro_property_value SELECT * from mlw_prod.pro_property_value ;
INSERT INTO mlw_product.pro_product_property SELECT pro_id,pro_prop_id,value_id,value,0,0,create_time from mlw_prod.pro_product_property ;
INSERT INTO mlw_product.pro_product SELECT p.pro_id,'',p.pro_id,0,pro_name,short_name,adv_name,bar_code,mlw_price,market_price,
trade_price,default_image_uri,image_uris,is_falls,falls_image_uri,falls_img_height,'',third_category_id,brand_id,supplier_id,admin_id,is_cod,state,create_time,on_time,off_time,delete_time,nation_time,update_time
 FROM mlw_prod.pro_product p,mlw_prod.pro_detail d WHERE p.pro_id = d.pro_id; 
INSERT INTO mlw_product.pro_action SELECT a.pro_id,love,one_score_num,two_score_num,three_score_num,four_score_num,five_score_num,score,real_sale_num,show_sale_num,real_view_num,show_view_num,comment_id,update_time,0,0,0,0
 FROM mlw_prod.pro_action a,mlw_prod.pro_detail d WHERE a.pro_id = d.pro_id ;
INSERT INTO mlw_product.price_change_log(pro_id,last_price,now_price,admin_id,admin_name,create_time) SELECT pro_id,mlw_price,mlw_price,admin_id,'',create_time FROM mlw_prod.pro_product ;
INSERT INTO mlw_product.pro_store_prod SELECT * from mlw_prod.pro_store_prod ;
INSERT INTO mlw_product.sku_self_property SELECT * FROM mlw_prod.pro_self_property ;

=======

---
所有已有的用户有一次抽奖机会：
CREATE TABLE `lottery_user_times` (
  `uid` int(11) NOT NULL DEFAULT '0' UNIQUE COMMENT '用户id',
  `times` varchar(32) NOT NULL DEFAULT '0' COMMENT '剩余次数',
  `source` varchar(32) DEFAULT '0' COMMENT '来源',
  `ip` varchar(64) NOT NULL DEFAULT '0' COMMENT 'ip',
  `create_time` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  PRIMARY KEY (`uid`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

insert into `lottery_user_times` 
SELECT
 `mlw_user`.`user_passport`.`uid`,1,'SYSTEM',null, now() 
FROM `mlw_user`.`user_passport`;


---
b2b 支付的表

use mlw_pay;
CREATE TABLE `b2b_pay_head` (
  `uid` int(11) NOT NULL,
  `target_uid` int(11) NOT NULL,
  `pay_type` varchar(20) NOT NULL,
  `total_amount` decimal(12,2) NOT NULL,
  `subject` varchar(300) DEFAULT NULL,
  `pay_status` varchar(32) DEFAULT NULL,
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `order_id` varchar(20) NOT NULL DEFAULT '',
  `extra_info` text,
  PRIMARY KEY (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='utf8_general_ci';

CREATE TABLE `b2b_pay_item` (
  `pay_id` varchar(20) NOT NULL,
  `order_id` varchar(20) NOT NULL,
  `pay_code` varchar(32) DEFAULT NULL,
  `pay_amount` decimal(12,2) DEFAULT NULL,
  `third_trade_no` varchar(50) DEFAULT NULL,
  `third_pay_uid` varchar(50) DEFAULT NULL,
  `third_pay_email` varchar(100) DEFAULT NULL,
  `pay_status` varchar(32) DEFAULT NULL,
  `extra_info` text,
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `success_time` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '支付成功时间',
  PRIMARY KEY (`pay_id`),
  KEY `item_ordId` (`order_id`,`pay_status`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='utf8_general_ci';

###############
二、更新zookeeper
###############
---------------- mq lzl -------------------------------------------------
1、测试需要配置pms缓存消息发送配置
    mq-job关于pms的目录结构有所改变，所以需要修改ice的配置
    修改bg-pms-service为：
    <springConfig>
       <config>conf/spring/pms/bg-pms-service.xml</config> 
    </springConfig>
2、切换pms相关的jdbc连接为mlw_product ；



-------------- web lsf (已添加 刘尚风) -----------------------------------------------------------
在 mlwconf/web/system.properties  节点中添加如下内容
  head.img.compress.ratio=40

---------- web lsf ------------------------
修改图片mq服务的配置文件：169:/data/software/mq_app/img_service/conf/conf/rabbitmq-msgcenter.xml 
  将该配置文件中taskworker 节点的 classname 值修改为 com.meiliwan.emall.service.image.ImageMsgTaskWorker

然后再编译和发布mlw-imagecode-web 和 img_service 服务


----------------pay lzl (已添加 刘尚风) ------------------------------------------------------------------------
支付宝app支付和wap支付相关，上线需要确认通知地址和回调地址，交易超时时间等。
在pay-web节点下的alipay.properties添加：
wap_partner=2088011330910864
wap_seller_email=xiaoling.tang@opi-corp.com
wap_private_key=MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBANf0tUZq/qEZYDORVSJs3OMalgrZIIjC55vgzPflsN0NRjOlyldTtFymXrJa/99eENDYxLlZoZ6feNfc/RDoRzjP10WNcD9Zje5dKQTQs6IMQ/0GmBEsktuzvbkl3z7R8zdx9b3MLpc3vFAMeIwvLcnJ5uyeJPdkpauoDLxAx2b9AgMBAAECgYBbzbdSHCHqsjLnOR0L6WNtV9v4+JyQBusWpNX9fDNXhVEWm6AMx5Sg3kjbYTvs5LwZTE00zhmaqQhiG5upGFVN1Vm8p6V1UyOYW20KNf9gGRo0kcUnSeh/PjE+1VKGdTZXPCqQ9mLr4nRiqtwOfBG3jNPSwLMZ6vcOYqPgmLA5AQJBAPToN+Ta5a6rDbi1HwlNj0Rn+vGuOi7P59tBn5rNlHtwBWTVWf7U5wvBrHn5R+l26VukDspJO8t/8tN5SO4JtXECQQDhvMpiQFOY8PWaEy35l31nNXR20D+a7cMCkKLyhb2GzS38M9wX2q2WFr8SdCd96UWFWWa8ZDezmiZrNvs9HxRNAkAQMxgXZD9TGW9z608dP2sdnD8mI18n34q3nxSemcCblaJVtCMazxxlU69D9jBCiiIPdL+hs8xnvpPiVyBy1mORAkEAtO6uRLwMhWy1Xq56zjBHOl9VHxphsNtb0AWAJeVeeNqiPiCPC6uiMMfAlJj3Qmuj5nM27k9hehpXKt5h16a+jQJAalZylP0WbzQPSCpQrfCFn9nv02pZMYmZswzkDpYJFDo3pKPX/oYEOIfuV8IGaixDgMwLqDQNNrYtI+sBHUk/zw==
wap_public_key=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDs5pCewROVsrMbkpdcNT7Uatvp1A0Dzm+IA2hBmGKgo8X2ugVw6LxbwRZaa7Tim3CkW21GPNnLs1UQO3GacKsSHZbIl05n/MmUIC0YVb7fpnJituDRrjBT6BZbsjZU7SD7bavPwRN7u6fpq/+2LO1jWyibsfI7yfn34+nUa91NAQIDAQAB
wap_gateway=http://wappaygw.alipay.com/service/rest.htm?
wap_notify_url=http://gateway.meiliwan.com/app/wapnotify
wap_call_back_url=https://gateway.meiliwan.com/app/wapcallback
wap_merchant_url=http://www.meiliwan.com
wap_token_service=alipay.wap.trade.create.direct
wap_pay_service=alipay.wap.auth.authAndExecute
wap_pay_expire=120
wap_sec_id=0001
wap_input_charset=utf-8

app_partner=2088011330910864
app_seller_email=xiaoling.tang@opi-corp.com
app_private_key=MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBANf0tUZq/qEZYDORVSJs3OMalgrZIIjC55vgzPflsN0NRjOlyldTtFymXrJa/99eENDYxLlZoZ6feNfc/RDoRzjP10WNcD9Zje5dKQTQs6IMQ/0GmBEsktuzvbkl3z7R8zdx9b3MLpc3vFAMeIwvLcnJ5uyeJPdkpauoDLxAx2b9AgMBAAECgYBbzbdSHCHqsjLnOR0L6WNtV9v4+JyQBusWpNX9fDNXhVEWm6AMx5Sg3kjbYTvs5LwZTE00zhmaqQhiG5upGFVN1Vm8p6V1UyOYW20KNf9gGRo0kcUnSeh/PjE+1VKGdTZXPCqQ9mLr4nRiqtwOfBG3jNPSwLMZ6vcOYqPgmLA5AQJBAPToN+Ta5a6rDbi1HwlNj0Rn+vGuOi7P59tBn5rNlHtwBWTVWf7U5wvBrHn5R+l26VukDspJO8t/8tN5SO4JtXECQQDhvMpiQFOY8PWaEy35l31nNXR20D+a7cMCkKLyhb2GzS38M9wX2q2WFr8SdCd96UWFWWa8ZDezmiZrNvs9HxRNAkAQMxgXZD9TGW9z608dP2sdnD8mI18n34q3nxSemcCblaJVtCMazxxlU69D9jBCiiIPdL+hs8xnvpPiVyBy1mORAkEAtO6uRLwMhWy1Xq56zjBHOl9VHxphsNtb0AWAJeVeeNqiPiCPC6uiMMfAlJj3Qmuj5nM27k9hehpXKt5h16a+jQJAalZylP0WbzQPSCpQrfCFn9nv02pZMYmZswzkDpYJFDo3pKPX/oYEOIfuV8IGaixDgMwLqDQNNrYtI+sBHUk/zw==
app_public_key=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnxj/9qwVfgoUh/y2W89L6BkRAFljhNhgPdyPuBV64bfQNN1PjbCzkIM6qRdKBoLPXmKKMiFYnkd6rAoprih3/PrQEB/VsW8OoM8fxn67UDYuyBTqA23MML9q1+ilIZwBC2AQ2UBVOrFXfFl75p6/B5KsiNG9zpgmLCUYuLkxpLQIDAQAB
app_notify_url=http://gateway.meiliwan.com/app/notify
app_show_url=http://www.meiliwan.com
app_pay_service=mobile.securitypay.pay
app_pay_expire=120m
app_sign_type=RSA
app_input_charset=utf-8

---------------- union yinggao.zhuo ------------------------------------------------------------------------
union-web/system.properties
security.EMS=123142534   （32位）


-------- -----------
#线上环境使用和测试环境不一样的 (已添加 刘尚风)
#顺丰
webServiceUrl.SF=http://bsp-oisp.sf-express.com/bsp-oisp/ws/expressService
checkword.SF=nLyvmUj1{KSnP:pl]kiWQutsuBdgi634
custId.SF=7710332275

#EMS
webServiceUrl.EMS=http://116.252.178.5/qjlup/VipOrderIdBindingEmsNoWsService/VipOrderIdBindingEmsNoWs

union-web/jdbc.properites  中改为线上的数据库ip

----------------oms lzl (已添加 刘尚风)------------------------------------------------------------------------
1、在zk上的oms-service中ice_config.xml增加
<service identity="spService" 
                         replicaGroup="spIceBoxReplicaGroup" 
                         connectMode="prod"
                         localPort="10005"/>
                         
2、在commons中的system.properties增加 (已添加 刘尚风)
act.send.money.startTime=2014-04-01 00:00:00
act.send.money.endTime=2014-04-30 23:59:59
act.full.send.money=19
act.send.money=5


备注：泰国节使用

3、支付模块(b2b使用)： (已添加 刘尚风)
b2b.callback.url=http://www.melibay.com/alipay/result/
b2b.notify_url=https://testgw.meiliwan.com/b2b/gateway/notify
b2b.return_url=https://gateway.meiliwan.com/b2b/gateway/callback



###############
三、编译发布程序代码
###############
编译基础包：
commons-utils
commons-cache
commons-webutils


根据开发过程中涉及的模块发布：
	/data/compileAnddeploy/prod_release 下发布service
		 ./release.sh mlw-base
		 ./release.sh mlw-oms
		 ./release.sh	mlw-stock
		 ./release.sh mlw-pms
		 ./release.sh mlw-sp
		 ./release.sh mlw-passport
		 ./release.sh mlw-wallet
		 ./release.sh mlw-gateway

		 ./release_mq.sh img_service
		 ./release_mq.sh bg_service
		 ./release_mq.sh bg_pms_service
		 
		 
		 
  	
 /data/compileAnddeploy/prod_release 下发布web
		 ./release_web.sh mlw-gateway-web
		 ./release_web.sh mlw-www-web
		 ./release_web.sh mlw-wallet-web
		 ./release_web.sh mlw-admin-web
		 ./release_web.sh mlw-passport-web
		 ./release_web.sh mlw-imagecode-web
		 
  	
  /data/compileAnddeploy/prod_release 下发布静态资源
     ./release_res.sh mlw-web-res



###############
四、修改nginx配置
###############
无


###############
五、使用线上后台管理员账户到后台添加菜单和功能项
###############
#########################营销系统
增加菜单
营销         (id:10337)(排序:0)(菜单)(权限Key:6cb58097b4f96a8bffe4716dbfab7d42)
邮件管理     (id:10338,/market/list,navTab)(排序:0)(菜单)(权限Key:a243b53ff1de83b93d32b64743ffee84)

2、菜单数据如下：
    SPU管理      b9f8d73751511e6bf47a8635fb70e019  菜单   /pms/product/spu-list   navTab  父节点：商品
    SPU查看      8aec9d133789532d0a3c713c081d1352 功能  /pms/product/spu-view     父节点：SPU管理
    SPU删除      df79a968ae166104724c7411308608df 功能  /pms/product/spu-delete     父节点：SPU管理
    SPU信息编辑 f6f03aa4654220af64642d5aa03965ed 功能 /pms/product/updatespu   父节点：SPU管理

    修改商品价格 7f625eea7d2b4726bf1dfbb5cd5db2f7 功能 /pms/product/updateskuPrice 父节点：SKU管理
    修改商品库存 fbc9b39d16c51510f067b1f36e8f1b5c 功能 /pms/product/updateskuStock 父节点：SKU管理
    修改商品条形码 fbc6dbcdd095a53dd83528a36752c053 功能 /pms/product/updateskuBarcode 父节点：SKU管理
    修改SKU自定义属性 c6733605afad72312d66fe828c55fdc4 功能 /pms/product/updateskuSelfProp 父节点：SKU管理
    修改地方馆信息 1635eb2b730d9bffa751cbca73e5df31 功能 /pms/product/updatesku-nationimage 父节点：SKU管理
    商品预览上架   ba693a664d734b3f418ee03ac078c7a5  功能 /pms/product/viewAndOn  父节点：SKU管理
    修改商品上架URL 改为：/pms/product/updatesku-up
    修改商品下架URL 改为：/pms/product/updatesku-down


###############
六、ice服务的回滚：
###############



###############
七、web服务的回滚：
###############

      
      
###############
八、CMS/静态资源版本号：6.0.0
###############
   

###############
九、缓存状态重置： 
    商品  flush 
    进入 55和57的/root目录下，执行./test.sh脚本清空pms数据
    进入57 /data/software/mongodb/bin 目录下执行 ./mongo
     > use redis-persist
     > db.baseServInfo.remove({_id:/pms/})

索引重建  
###############


线上的皮要确认；


